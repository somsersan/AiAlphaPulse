version: '3.8'

services:
  # Воркер для обработки пайплайна (Нормализация → Дедупликация → LLM)
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    container_name: alphapulse_pipeline
    network_mode: "host"  # Используем host network для доступа к локальной БД
    environment:
      # PostgreSQL подключение (локальная БД на VM)
      POSTGRES_HOST: ${POSTGRES_HOST:-localhost}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-alphapulse}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-04102025}
      
      # ProxyAPI.ru
      PROXYAPI_KEY: ${PROXYAPI_KEY}
      LLM_MODEL: ${LLM_MODEL:-anthropic/claude-3.5-haiku}
      LLM_ANALYSIS_MODEL: ${LLM_ANALYSIS_MODEL:-anthropic/claude-3.5-sonnet}
      LLM_DELAY: ${LLM_DELAY:-1.0}
      
      # Настройки пайплайна
      PIPELINE_CHECK_INTERVAL: ${PIPELINE_CHECK_INTERVAL:-300}  # 5 минут
      PIPELINE_BATCH_SIZE: ${PIPELINE_BATCH_SIZE:-100}
      PIPELINE_LLM_LIMIT: ${PIPELINE_LLM_LIMIT:-50}
    
    volumes:
      - ./logs:/app/logs
      - ./.env:/app/.env:ro
      - ./src:/app/src:ro  # Монтируем исходный код для быстрого обновления
    
    command: python -u pipeline_worker.py
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep pipeline_worker.py || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Telegram бот
  telegram_bot:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    container_name: alphapulse_telegram_bot
    network_mode: "host"  # Используем host network для доступа к локальной БД
    environment:
      # PostgreSQL подключение (локальная БД на VM)
      POSTGRES_HOST: ${POSTGRES_HOST:-localhost}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-alphapulse}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-04102025}
      
      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}  # Опционально для обратной совместимости
      
      # ProxyAPI.ru для генерации анализа
      PROXYAPI_KEY: ${PROXYAPI_KEY}
      LLM_MODEL: ${LLM_MODEL:-anthropic/claude-3.5-haiku}
      LLM_ANALYSIS_MODEL: ${LLM_ANALYSIS_MODEL:-anthropic/claude-3.5-sonnet}
      
      # Мониторинг горячих новостей
      HOT_NEWS_THRESHOLD: ${HOT_NEWS_THRESHOLD:-0.7}
      HOT_NEWS_INTERVAL: ${HOT_NEWS_INTERVAL:-60}
    
    volumes:
      - ./.env:/app/.env:ro
      - ./src:/app/src:ro  # Монтируем исходный код для быстрого обновления
    
    command: python -u run_telegram_bot.py
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep run_telegram_bot.py || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# КОНФИГУРАЦИЯ AI ALPHA PULSE - 2 СЕРВИСА
# ============================================================================
#
# АРХИТЕКТУРА:
# 1. pipeline (pipeline_worker.py) - Обработка пайплайна: Нормализация → Дедупликация → LLM
# 2. telegram_bot (run_telegram_bot.py) - Telegram бот для отправки новостей подписчикам
#
# УДАЛЕННЫЙ СЕРВИС:
# - parser (parser_worker.py) - Парсер новостей запускается из другого контейнера на сервере
#
# ПОДКЛЮЧЕНИЕ К БД:
# - PostgreSQL запущен локально на VM (localhost:5432)
# - Контейнеры используют network_mode: "host" для прямого доступа
# - БД: "alphapulse", пользователь: "admin"
#
# ПОДПИСЧИКИ:
# - Пользователи подписываются через команду /subscribe в боте
# - Подписки хранятся в таблице telegram_subscribers
#
# ПОТОК ДАННЫХ:
# Parser (внешний) → financial_news_view → normalized_articles → 
# story_clusters → llm_analyzed_news → Telegram Bot → Подписчики
# ============================================================================



