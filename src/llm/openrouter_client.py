"""–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenRouter API"""
import os
import requests
import json
from typing import Dict, List, Optional
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()


class OpenRouterClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è OpenRouter API"""
    
    def __init__(self, api_key: str = None, model: str = None):
        self.api_key = api_key or os.getenv("OPENROUTER_API_KEY")
        if not self.api_key:
            raise ValueError("OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        self.model = model or os.getenv("LLM_MODEL", "deepseek/deepseek-chat")
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
        
    def analyze_news(self, headline: str, content: str) -> Dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–æ–≤–æ—Å—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç hotness –∏ —Ç–∏–∫–µ—Ä—ã
        
        Returns:
            {
                'hotness': float (0-1),
                'tickers': List[str],
                'reasoning': str
            }
        """
        
        prompt = f"""–¢—ã - —Å—Ç—Ä–æ–≥–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –û—Ü–µ–Ω–∏ –Ω–æ–≤–æ—Å—Ç—å –ø–æ –º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π —Ñ–æ—Ä–º—É–ª–µ hotness –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤.

–ó–ê–ì–û–õ–û–í–û–ö: {headline}
–¢–ï–ö–°–¢: {content[:2000]}

–§–û–†–ú–£–õ–ê HOTNESS (0.00 - 1.00):
hotness = scale √ó market_impact + urgency + novelty + materiality

–ì–î–ï –ö–ê–ñ–î–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢:

1) SCALE (–º–∞—Å—à—Ç–∞–± —Å–æ–±—ã—Ç–∏—è) ‚Äî –≤–µ—Å 0-0.30:
   ‚Ä¢ 0.30: –ì–ª–æ–±–∞–ª—å–Ω–æ–µ (–º–∏—Ä–æ–≤–∞—è –≤–æ–π–Ω–∞, –∫—Ä–∞—Ö G7 —ç–∫–æ–Ω–æ–º–∏–∫–∏, –¥–µ—Ñ–æ–ª—Ç –°–®–ê/–ö–∏—Ç–∞—è)
   ‚Ä¢ 0.20-0.25: –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ (—Ä–µ—à–µ–Ω–∏–µ –¶–ë/–§–†–° –ø–æ —Å—Ç–∞–≤–∫–µ, —Å–º–µ–Ω–∞ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞, –∫—Ä—É–ø–Ω–µ–π—à–∏–µ IPO >$10B)
   ‚Ä¢ 0.10-0.15: –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–µ/–°–µ–∫—Ç–æ—Ä–Ω–æ–µ (–æ—Ç—Ä–∞—Å–ª–µ–≤–æ–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–ª–∏—è–Ω–∏–µ –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π)
   ‚Ä¢ 0.05-0.10: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ (–∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã —Ç–æ–ø-100, M&A —Å—Ä–µ–¥–Ω–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π)
   ‚Ä¢ 0.00-0.05: –õ–æ–∫–∞–ª—å–Ω–æ–µ/–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ

2) MARKET_IMPACT (–ø—Ä—è–º–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä—ã–Ω–∫–∏) ‚Äî –≤–µ—Å 0-0.30:
   ‚Ä¢ 0.30: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ (—Å–∞–Ω–∫—Ü–∏–∏ –Ω–∞ —Ü–µ–ª—É—é –æ—Ç—Ä–∞—Å–ª—å, –¥–µ—Ñ–æ–ª—Ç, –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ Fortune 500)
   ‚Ä¢ 0.20-0.25: –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ–µ –ø—Ä—è–º–æ–µ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫, –Ω–æ–≤—ã–µ –Ω–∞–ª–æ–≥–∏, —Ç–∞—Ä–∏—Ñ—ã)
   ‚Ä¢ 0.10-0.15: –ö–æ—Å–≤–µ–Ω–Ω–æ–µ (—Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Ç—Ä–µ–Ω–¥—ã, –ø—Ä–æ–≥–Ω–æ–∑—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤)
   ‚Ä¢ 0.05-0.10: –°–ª–∞–±–æ–µ –∫–æ—Å–≤–µ–Ω–Ω–æ–µ (–æ–±—â–∏–µ –º–∞–∫—Ä–æ-–Ω–æ–≤–æ—Å—Ç–∏, –ø–ª–∞–Ω—ã –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π)
   ‚Ä¢ 0.00-0.05: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ/–Ω–µ—Ç

3) URGENCY (—Å—Ä–æ—á–Ω–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏) ‚Äî –≤–µ—Å 0-0.20:
   ‚Ä¢ 0.20: –¢—Ä–µ–±—É–µ—Ç –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô —Ä–µ–∞–∫—Ü–∏–∏ (circuit breaker, halt —Ç–æ—Ä–≥–æ–≤, —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è)
   ‚Ä¢ 0.15: –í–∞–∂–Ω–æ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã (breaking news —Å —Ü–µ–Ω–æ–≤—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º)
   ‚Ä¢ 0.10: –ê–∫—Ç—É–∞–ª—å–Ω–æ —Å–µ–≥–æ–¥–Ω—è (—Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, –≤–∞–∂–Ω—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è)
   ‚Ä¢ 0.05: –í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ (–ø–ª–∞–Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è, –∞–Ω–æ–Ω—Å—ã)
   ‚Ä¢ 0.00: –ù–µ —Å—Ä–æ—á–Ω–æ (–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –æ–±–∑–æ—Ä—ã, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã)

4) NOVELTY (–Ω–æ–≤–∏–∑–Ω–∞/—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å) ‚Äî –≤–µ—Å 0-0.20:
   ‚Ä¢ 0.20: –ë–µ—Å–ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–Ω–æ–µ (–ø–µ—Ä–≤–æ–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏, —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–µ)
   ‚Ä¢ 0.15: –†–µ–¥–∫–æ–µ (—Ä–∞–∑ –≤ 5+ –ª–µ—Ç: –∫—Ä–∏–∑–∏—Å—ã, –º–µ–≥–∞-—Å–¥–µ–ª–∫–∏)
   ‚Ä¢ 0.10: –ù–µ—á–∞—Å—Ç–æ–µ (—Ä–∞–∑ –≤ –≥–æ–¥: –∫—Ä—É–ø–Ω—ã–µ IPO, —Å–º–µ–Ω–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –¶–ë)
   ‚Ä¢ 0.05: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ (–µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ: –æ—Ç—á—ë—Ç—ã, –¥–∏–≤–∏–¥–µ–Ω–¥—ã)
   ‚Ä¢ 0.00: –†—É—Ç–∏–Ω–Ω–æ–µ (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏)

5) MATERIALITY (–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ—Å—Ç—å/–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–æ–≤) ‚Äî –≤–µ—Å 0-0.10:
   ‚Ä¢ 0.10: –ù–∞–∑–≤–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏/—Ç–∏–∫–µ—Ä—ã —Å —Ü–∏—Ñ—Ä–∞–º–∏ (–≤—ã—Ä—É—á–∫–∞, —Ü–µ–Ω—ã, –æ–±—ä—ë–º—ã)
   ‚Ä¢ 0.07: –ù–∞–∑–≤–∞–Ω—ã –∫–æ–º–ø–∞–Ω–∏–∏ –±–µ–∑ —Ü–∏—Ñ—Ä –∏–ª–∏ —Å–µ–∫—Ç–æ—Ä —Å —Ü–∏—Ñ—Ä–∞–º–∏
   ‚Ä¢ 0.05: –û–±—â–∏–π —Å–µ–∫—Ç–æ—Ä/—Ä—ã–Ω–æ–∫ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π
   ‚Ä¢ 0.02: –£–ø–æ–º–∏–Ω–∞—é—Ç—Å—è —Ä—ã–Ω–∫–∏ –∫–æ—Å–≤–µ–Ω–Ω–æ
   ‚Ä¢ 0.00: –ù–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤

–§–ò–õ–¨–¢–† –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–ò:
–ï—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –ù–ï –æ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö/—ç–∫–æ–Ω–æ–º–∏–∫–µ/—Ä—ã–Ω–∫–∞—Ö (—Å–ø–æ—Ä—Ç, –ø–æ–≥–æ–¥–∞, –∫—Ä–∏–º–∏–Ω–∞–ª, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –±—ã—Ç–æ–≤–æ–µ), —É—Å—Ç–∞–Ω–æ–≤–∏:
‚Ä¢ hotness = 0.00‚Äì0.10 (—Å—É–º–º–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–ª–∏–∑–∫–∞ –∫ –Ω—É–ª—é)
‚Ä¢ tickers = []
‚Ä¢ reasoning = "–ù–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤"

–ò–ó–í–õ–ï–ß–ï–ù–ò–ï –¢–ò–ö–ï–†–û–í:
–ù–∞–π–¥–∏ –í–°–ï —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
‚Ä¢ –ê–∫—Ü–∏–∏: AAPL, TSLA, SBER, GAZP, NVDA
‚Ä¢ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã: BTC, ETH, SOL
‚Ä¢ –ò–Ω–¥–µ–∫—Å—ã: S&P500, MOEX, NASDAQ, Dow
‚Ä¢ –í–∞–ª—é—Ç—ã/–°—Ç—Ä–∞–Ω—ã: USD, EUR, RU, USA, CN, EU
‚Ä¢ –°—ã—Ä—å—ë: GOLD, OIL, GAS

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –ü–†–û –¢–û–ß–ù–û–°–¢–¨:
‚Ä¢ –ö–ê–ñ–î–ê–Ø –Ω–æ–≤–æ—Å—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–ê ‚Üí hotness –î–û–õ–ñ–ï–ù —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏!
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–´–ï –∑–Ω–∞—á–µ–Ω–∏—è —Å 3 –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π: 0.234, 0.567, 0.891
‚Ä¢ –ó–ê–ü–†–ï–©–ï–ù–û –æ–∫—Ä—É–≥–ª—è—Ç—å –¥–æ 0.25, 0.60, 0.90, 0.67, 0.70!
‚Ä¢ –û—Ü–µ–Ω–∏–≤–∞–π –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –°–¢–†–û–ì–û –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º - –Ω–µ –ø–æ–¥–≥–æ–Ω—è–π –ø–æ–¥ "–∫—Ä–∞—Å–∏–≤–æ–µ" —á–∏—Å–ª–æ
‚Ä¢ –°—É–º–º–∞ –≤—Å–µ—Ö 5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ = –∏—Ç–æ–≥–æ–≤—ã–π hotness (—Å—á–∏—Ç–∞–π —Ç–æ—á–Ω–æ, –¥–æ —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–Ω–∞–∫–∞!)

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –†–ê–ó–õ–ò–ß–ê–Æ–©–ï–ô–°–Ø –û–¶–ï–ù–ö–ò:
‚Ä¢ "–ü–µ–Ω—Å–∏–∏ –≤ –†–§ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 45–ö": 0.147 = 0.082+0.031+0.018+0.005+0.011
‚Ä¢ "–ë–∏—Ç–∫–æ–∏–Ω >$120K –≤–ø–µ—Ä–≤—ã–µ —Å –∞–≤–≥—É—Å—Ç–∞": 0.583 = 0.152+0.218+0.121+0.079+0.013
‚Ä¢ "–¶–ë –†–§ –ø–æ–≤—ã—Å–∏–ª —Å—Ç–∞–≤–∫—É –¥–æ 21%": 0.821 = 0.234+0.271+0.184+0.108+0.024
‚Ä¢ "–û–±–∑–æ—Ä —Ä—ã–Ω–∫–∞, –æ–±—â–∏–µ —Ç—Ä–µ–Ω–¥—ã": 0.089 = 0.041+0.019+0.011+0.000+0.018
‚Ä¢ "–ù–æ–≤—ã–π CEO –Ω–∞–∑–Ω–∞—á–µ–Ω –≤ —Å—Ä–µ–¥–Ω—é—é –∫–æ–º–ø–∞–Ω–∏—é": 0.213 = 0.091+0.057+0.033+0.026+0.006

–°–¢–†–û–ì–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï:
–ï—Å–ª–∏ –¥–≤–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ—Ö–æ–∂–∏ –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ - –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–∞–π –∏–º –†–ê–ó–ù–´–ï –æ—Ü–µ–Ω–∫–∏ (—Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ 0.001)!

–û–¢–í–ï–¢ (–¢–û–õ–¨–ö–û JSON, –ë–ï–ó –¢–ï–ö–°–¢–ê):
{{
    "hotness": 0.583,
    "tickers": ["BTC", "USD"],
    "reasoning": "scale=0.152, market_impact=0.218, urgency=0.121, novelty=0.079, materiality=0.013"
}}"""

        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "model": self.model,
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "temperature": 0.5,  # –ü–æ–≤—ã—à–∞–µ–º –¥–ª—è –±–æ–ª—å—à–µ–π –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ü–µ–Ω–æ–∫
            "max_tokens": 500,
            "top_p": 0.95  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
        }
        
        max_retries = 2  # –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–æ 2 —Ä–∞–∑ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö
        
        for attempt in range(max_retries):
            try:
                response = requests.post(
                    self.base_url,
                    headers=headers,
                    json=payload,
                    timeout=30
                )
                
                # –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                if response.status_code == 403:
                    error_msg = response.json() if response.content else {}
                    print(f"\n‚ùå –û—à–∏–±–∫–∞ 403 Forbidden:")
                    print(f"   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    print(f"   1. –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á")
                    print(f"   2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ")
                    print(f"   3. API –∫–ª—é—á –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")
                    print(f"   –î–µ—Ç–∞–ª–∏: {error_msg}")
                    raise ValueError(f"API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: {error_msg}")
                
                if response.status_code == 429:
                    print(f"\n‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...")
                    raise ValueError("Rate limit exceeded")
                
                response.raise_for_status()
                result = response.json()
                raw_content = result['choices'][0]['message']['content']
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏
                if not raw_content or not raw_content.strip():
                    if attempt < max_retries - 1:
                        print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}: LLM –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç, –ø–æ–≤—Ç–æ—Ä—è—é...")
                        import time
                        time.sleep(1)
                        continue
                    else:
                        print(f"‚ùå LLM –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫!")
                        print(f"  –ú–æ–¥–µ–ª—å: {self.model}")
                        print(f"  –ó–∞–≥–æ–ª–æ–≤–æ–∫: {headline[:50]}...")
                        return {'hotness': 0.0, 'tickers': [], 'reasoning': '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç LLM'}
                
                # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
                import re
                content = raw_content
                
                # 1. –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏
                if "```json" in content:
                    content = content.split("```json")[1].split("```")[0]
                elif "```" in content:
                    content = content.split("```")[1].split("```")[0]
                
                # 2. –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON –æ–±—ä–µ–∫—Ç –≤ —Ç–µ–∫—Å—Ç–µ (—Å–∞–º—ã–π –ø–æ–ª–Ω—ã–π)
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ç–æ—á–Ω—É—é —Ä–µ–≥—É–ª—è—Ä–∫—É –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                json_pattern = r'\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}'
                all_matches = list(re.finditer(json_pattern, content, re.DOTALL))
                
                if all_matches:
                    # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π (–æ–±—ã—á–Ω–æ —Å–∞–º—ã–π –ø–æ–ª–Ω—ã–π) JSON –æ–±—ä–µ–∫—Ç
                    content = all_matches[-1].group(0)
                else:
                    # –ï—Å–ª–∏ regex –Ω–µ –Ω–∞—à—ë–ª, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤—Ä—É—á–Ω—É—é –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π { –¥–æ }
                    start = content.rfind('{')
                    end = content.rfind('}')
                    if start != -1 and end != -1 and start < end:
                        content = content[start:end+1]
                    else:
                        # –í–æ–æ–±—â–µ –Ω–µ –Ω–∞—à–ª–∏ JSON
                        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ!")
                        print(f"  –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç: {raw_content[:300]}")
                        return {'hotness': 0.0, 'tickers': [], 'reasoning': 'JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ'}
                
                # 3. –û—á–∏—â–∞–µ–º –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
                content = content.strip()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—É—Å—Ç–æ–π
                if not content or len(content) < 10:
                    print(f"‚ö†Ô∏è –ü—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π JSON –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏")
                    print(f"  –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç: {raw_content[:300]}")
                    print(f"  –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {content}")
                    return {'hotness': 0.0, 'tickers': [], 'reasoning': '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π JSON'}
                
                # –ü–∞—Ä—Å–∏–º JSON
                try:
                    analysis = json.loads(content)
                except json.JSONDecodeError as e:
                    print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: {e}")
                    print(f"–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π JSON: {content[:200]}")
                    return {'hotness': 0.0, 'tickers': [], 'reasoning': '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON'}
                
                # –í–∞–ª–∏–¥–∞—Ü–∏—è
                hotness = float(analysis.get('hotness', 0.5))
                hotness = max(0.0, min(1.0, hotness))  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 0-1
                
                tickers = analysis.get('tickers', [])
                if not isinstance(tickers, list):
                    tickers = []
                
                reasoning = analysis.get('reasoning', '')
                
                # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º hotness
                if hotness > 0.01:
                    print(f"  üìä –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: hotness={hotness:.3f}, tickers={tickers}")
                
                return {
                    'hotness': hotness,
                    'tickers': tickers,
                    'reasoning': reasoning  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
                }
                
            except requests.exceptions.RequestException as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞: {e}")
                return {'hotness': 0.0, 'tickers': [], 'reasoning': ''}
            except Exception as e:
                print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
                return {'hotness': 0.0, 'tickers': [], 'reasoning': ''}

